<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kakao Map with Modal</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        /* 수평 가운데 정렬 */
        align-items: center;
        /* 수직 가운데 정렬 */
        height: 100vh;
        margin: 0;
      }

      .container {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        height: 100%;
      }

      section {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .overlay-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 5px;
        background-color: #ffffff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        width: 100px;
        /* 적절한 너비 설정 */
        box-sizing: border-box;
        /* padding과 border를 width에 포함시킴 */
        margin-bottom: 150%;
      }

      .overlay-content h3,
      .overlay-content span {
        margin: 0;
        /* 기본 마진 제거 */
        padding: 0;
        /* 기본 패딩 제거 */
        box-sizing: border-box;
        /* padding과 border를 너비에 포함 */
        width: 100%;
        /* 부모의 너비를 채우도록 설정 */
        text-align: center;
        /* 텍스트 중앙 정렬 */
        white-space: nowrap;
        /* 텍스트 줄바꿈 방지 */
        overflow: hidden;
        /* 넘치는 텍스트 숨기기 */
        text-overflow: ellipsis;
        /* 넘치는 텍스트 생략 표시 (...) */
      }

      .header-button {
            background-color: #4CAF50; /* 배경색 설정 */
            color: white; /* 텍스트 색상 설정 */
            border: none; /* 테두리 제거 */
            padding: 10px 20px; /* 패딩 설정 */
            text-align: center; /* 텍스트 가운데 정렬 */
            text-decoration: none; /* 텍스트 밑줄 제거 */
            display: inline-block; /* 인라인 블록 설정 */
            font-size: 16px; /* 폰트 크기 설정 */
            margin: 4px 2px; /* 마진 설정 */
            cursor: pointer; /* 커서 모양 설정 */
            border-radius: 4px; /* 모서리 둥글게 설정 */
        }

        .header-button:hover {
            background-color: #45a049; /* 마우스 오버 시 배경색 설정 */
        }

      .modal {
        display: none;
        /* 평소에는 보이지 않도록 설정 */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal .modal_popup {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: #ffffff;
        border-radius: 20px;
      }

      #map {
        width: 500px;
        height: 100%;
        filter: none;
        transition: filter 0.2s;
      }

      .modal .modal_popup .close_btn {
        display: block;
        padding: 10px 20px;
        background-color: rgb(116, 0, 0);
        border: none;
        border-radius: 5px;
        color: #fff;
        cursor: pointer;
        transition: box-shadow 0.2s;
        margin: 5px auto;
        /* 버튼을 수평으로 가운데 배치 */
      }

      #modalTitle,
      #modalContent {
        text-align: center;
      }

      #site-header {
        background-color: #cfe5d8d3;
        height: 65px;
        width: 500px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #butten-header {
        background-color: #cfe5d8d3;
        height: 25px;
        width: 500px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #map {
        width: 100%;
        height: 100%;
        filter: none;
        transition: filter 0.2s;
      }

      #map.blur {
        filter: blur(5px);
      }

      #logo {
        font-size: 2rem;
        /* 로고의 크기 */
        font-weight: bold;
        /* 굵은 글씨 */
        color: hsla(128, 85%, 47%, 0.233);
        /* 글씨 색상 */
        text-transform: uppercase;
        /* 대문자로 변환 */
        letter-spacing: 1px;
        /* 글자 사이 간격 */
        background: linear-gradient(
          25deg,
          #539546,
          #18d10b
        ); /* 그라데이션 배경 */
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        padding: 10px 20px;
        text-align: center;
      }

      footer {
        background-color: #cfe5d8d3;
        padding: 10px 0;
        text-align: center;
        width: 100%;
      }

      footer ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }
      footer li {
        display: inline;
        margin: 0 15px;
      }

      footer a {
        text-decoration: none;
        color: #333;
      }

      footer a:hover {
        text-decoration: underline;
      }

    </style>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0483db3a4bdedf858905037e9fe907c9"
    ></script>
  </head>

  <body>
    <!--jQuery 라이브러리-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY"></script>
    <!-- 모달 팝업 -->
    <div class="modal">
      <div class="modal_popup">
        <h3 id="modalTitle"></h3>
        <span id="modalContent"></span>
        <button type="button" class="close_btn">닫기</button>
      </div>
    </div>

    <!-- end 모달 팝업 -->
    <div class="container">
      <header id="site-header">
        <div id="logo">GFOOD</div>
        <button class="header-button" id="a-button" data-type="a">결식 카드</button>
        <button class="header-button" id="b-button" data-type="b">착한식당</button>
        <button class="header-button" id="c-button" data-type="c">편의점</button>
      </header>
      <section>
        <div id="map"></div>
      </section>
      <footer>
        <ul>
          <li><a href="index.html" id="back">홈</a></li>
          <li><a href="search.html" id="search">검색</a></li>
          <li><a href="reservation.html" id="reservation">예약</a></li>
          <li><a href="profile.html" id="profile">회원정보</a></li>
        </ul>
      </footer>
    </div>

    <script>
      const modal = document.querySelector(".modal");
      const modalClose = document.querySelector(".close_btn");
      const mapElement = document.getElementById("map");
      const modalTitle = document.getElementById("modalTitle");
      const modalContent = document.getElementById("modalContent");

      // 닫기 버튼을 눌렀을 때 모달팝업이 닫힘
      modalClose.addEventListener("click", function () {
        modal.style.display = "none";
        mapElement.classList.remove("blur"); // 지도 흐리게 제거
      });

      var mapContainer = document.getElementById("map"); // 지도를 담을 영역의 DOM 레퍼런스
      var mapOption = {
        // 지도를 생성할 때 필요한 기본 옵션
        center: new kakao.maps.LatLng(37.5206, 126.9945), // 지도의 중심좌표
        level: 4, // 지도의 레벨(확대, 축소 정도)
      };
      var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성 및 객체 리턴

      let markers = [];
      let listEndOverlay = [];
      let currentType = null;


      // <!-- 마커 이미지 설정용 -->


    const markerImages = {
      a: "https://ifh.cc/g/yHPtBj.png", 
      b: "https://ifh.cc/g/500jMW.png", 
      c: "https://ifh.cc/g/pxATFR.png"
    };

    // 서버에서 데이터를 가져오는 함수
    function getData(type) {
      return $.ajax({
        url: '/get-locations', // 서버의 엔드포인트
        method: 'GET',
        data: { business_type: type },
        dataType: 'json'
      });
    }
      // 마커를 지도에 추가하는 함수
      function addMarker(store) {
        let pos = new kakao.maps.LatLng(store.x_coordinate, store.y_coordinate);

        // 타입에 따른 마커 이미지 설정용
        const imageSrc = 'https://ifh.cc/g/500jMW.png'; // markerImages[store.type]; -> 임시 지정 DB값 에따라 변경하도록
        const imageSize = new kakao.maps.Size(94, 99); // 마커 이미지 크기
        const imageOption = { offset: new kakao.maps.Point(27, 69) }; // 마커 이미지의 중심좌표 설정

        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
        //마커 생성용
        const marker = new kakao.maps.Marker({
          map: map,
          position: pos,
          image: markerImage // 마커 이미지 설정
        });

      kakao.maps.event.addListener(marker, "click", async function () {
        try {
            var overlayContent = document.createElement("div");
            overlayContent.innerHTML = `<div class="overlay-content">
            <h3> ${store.name} </h3>
            <span> ${store.type} </span>
            </div>`;
            overlayContent.querySelector(".overlay-content").onclick = function () {
              getDetail(store);
            };
            var overlay = new kakao.maps.CustomOverlay({
              position: pos,
              content: overlayContent,
            });
            listEndOverlay.push(overlay);
            overlay.setMap(map);
        } 
        catch (error) {
          console.error("Error fetching menu data:", error);
        }
        });

      markers.push(marker);
      }

    // 기존 마커를 모두 제거하는 함수
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
  }

  // 특정 타입의 데이터를 로드하는 함수
  async function loadStores(type) {
    try {
      const location = map.getCenter();
      const response = await fetch(`http://localhost:8002/stores?type=${type}&lat=${location.getLat()}&lng=${location.getLng()}`);
      const stores = await response.json();
      clearMarkers();
      stores.forEach(store => addMarker(store));
    } 
    catch (error) {
      console.error("Error fetching store data:", error);
    }
  }

   // 버튼 클릭 이벤트 처리
   document.querySelectorAll('.header-button').forEach(button => {
    button.addEventListener('click', function () {
      const currentType = this.getAttribute('data-type');
      getData(currentType).done(function(locations) {
        createMarkers(locations);
      });
    });
  });

   // 지도 드래그 종료 시 마커 재로드
  kakao.maps.event.addListener(map, 'dragend', function () {
    if (currentType) {
      loadStores(currentType);
    }
  });

  async function getDetail(store) {
    while (listEndOverlay.length > 0) {
      listEndOverlay.pop().setMap(null);
    }
    try {
      modal.style.display = "block";
      mapElement.classList.add("blur"); // 지도 흐리게
      modalTitle.textContent = store.name;

      const menuResponse = await fetch(`http://127.0.0.1:8002/stores/${store.idx}/menu`);
      const menuData = await menuResponse.json();
      var menuList = "";
      for (let i = 0; i < menuData.length; i++) {
        menuList += `${menuData[i].name} : ${menuData[i].price}\n`;
      }
      modalContent.innerText = menuList;
    } 
    catch (error) {
      console.error("Error fetching menu data:", error);
    }
  }

    </script>
  </body>
</html>