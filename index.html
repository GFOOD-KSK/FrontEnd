<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GFOOD</title>
    <!-- Google Material Icons 폰트 로드 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
     body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            overflow: hidden;
        }


section {
  flex-grow: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
}

.overlay-content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 5px;
  background-color: #ffffff;
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  width: 100px;
  /* 적절한 너비 설정 */
  box-sizing: border-box;
  /* padding과 border를 width에 포함시킴 */
  margin-bottom: 150%;
}

.overlay-content h3,
.overlay-content span {
  margin: 0;
  /* 기본 마진 제거 */
  padding: 0;
  /* 기본 패딩 제거 */
  box-sizing: border-box;
  /* padding과 border를 너비에 포함 */
  width: 100%;
  /* 부모의 너비를 채우도록 설정 */
  text-align: center;
  /* 텍스트 중앙 정렬 */
  white-space: nowrap;
  /* 텍스트 줄바꿈 방지 */
  overflow: hidden;
  /* 넘치는 텍스트 숨기기 */
  text-overflow: ellipsis;
  /* 넘치는 텍스트 생략 표시 (...) */
}

.header-button {
  background-color: #0b7e0f; /* 배경색 설정 */
  color: white; /* 텍스트 색상 설정 */
  border: none; /* 테두리 제거 */
  padding: 10px 20px; /* 패딩 설정 */
  text-align: center; /* 텍스트 가운데 정렬 */
  text-decoration: none; /* 텍스트 밑줄 제거 */
  display: inline-block; /* 인라인 블록 설정 */
  font-size: 16px; /* 폰트 크기 설정 */
  margin: 4px 2px; /* 마진 설정 */
  cursor: pointer; /* 커서 모양 설정 */
  border-radius: 4px; /* 모서리 둥글게 설정 */
}

.header-button:hover {
  background-color: #125c15; /* 마우스 오버 시 배경색 설정 */
}

.modal {
  display: none;
  /* 평소에는 보이지 않도록 설정 */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
}

.modal .modal_popup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px;
  background: #ffffff;
  border-radius: 20px;
}

#map {
  width: 500px;
  height: 100%;
  filter: none;
  transition: filter 0.2s;
}

/* 모달 배경 스타일 */
.modal {
  display: none;  /* 모달을 기본적으로 숨깁니다. */
  position: fixed;
  z-index: 1000;  /* 모달을 지도 위로 올림 */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);  /* 반투명한 배경 */
  justify-content: center;
  align-items: center;
  display: flex;  /* flexbox 레이아웃 적용 */
}

/* 모달 팝업 스타일 */
.modal_popup {
  background-color: #fff;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 400px;  /* 최대 너비 설정 */
  max-height: 80%;  /* 최대 높이 설정 */
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  overflow-y: auto;  /* 세로 스크롤 가능 */
  display: flex;
  flex-direction: column;
  align-items: flex-start;  /* 왼쪽 정렬 */
  z-index: 1001;  /* 모달 팝업을 모달 배경 위로 올림 */
}

/* 헤더 스타일 */
#site-header {
  background-color: #4caf50;
  height: 65px;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#logo {
  font-size: 2rem;
  font-weight: bold;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* 가게 이름 스타일 */
#modalTitle {
  font-size: 32px;
  font-weight: bold;
  margin-right: 10px;
}

/* 가게 카테고리 스타일 */
#storeCategory {
  font-size: 14px;
  color: #555;
  margin-right: auto;
}

/* 음식점 유형 스타일 */
#storeTypeCircle {
  background-color: #ddd;
  color: #333;
  font-size: 14px;
  font-weight: bold;
  padding: 5px 10px;
  border-radius: 50%;
  text-align: center;
}

/* 버튼 컨테이너 스타일 (가게 이름 아래) */
.button_below_title {
  display: flex;
  width: 100%;
  margin-bottom: 20px;
}

/* 예약 페이지 버튼 스타일 */
.reserve_page_btn {
  background-color: #4CAF50;  /* 녹색 배경 */
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-right: 10px;  /* 버튼 간 간격 */
}

.reserve_page_btn:hover {
  background-color: #45a049;  /* 호버 시 더 진한 녹색 */
}

/* 길찾기 페이지 버튼 스타일 */
.direction_page_btn {
  background-color: #2196F3;  /* 파란색 배경 */
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.direction_page_btn:hover {
  background-color: #0b7dda;  /* 호버 시 더 진한 파란색 */
}

/* 모달 내용 스타일 */
#modalContent {
  width: 100%;
  margin-bottom: 20px;
  text-align: left;
}

/* 메뉴 리스트 스타일 */
.menu_list {
  list-style-type: none;
  padding: 0;
  width: 100%;
  max-height: 200px;  /* 메뉴 리스트에 최대 높이 설정 */
  overflow-y: auto;  /* 세로 스크롤 가능 */
}

.menu_item {
  font-size: 18px;
  padding: 10px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}

/* 닫기 버튼 스타일 */
.close_btn {
  background-color: #f44336;  /* 빨간색 배경 */
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
  text-align: center;
}

.close_btn:hover {
  background-color: #da190b;  /* 호버 시 더 진한 빨간색 */
}

footer {
  background-color: #4caf50;
  padding: 10px 0;
  text-align: center;
  width: 100%;
  
}

footer ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

footer li {
  display: inline;
  margin: 0 15px;
}

footer a {
  text-decoration: none;
  color: #ffffff;
}

footer a:hover {
  text-decoration: underline;
}

.material-symbols-outlined {
  font-variation-settings:
    'FILL' 0,
    'wght' 400,
    'GRAD' 0,
    'opsz' 24;
}
.blur {
    filter: blur(5px);
}


    </style>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0483db3a4bdedf858905037e9fe907c9&libraries=clusterer"
    ></script>
  </head>

  <body>
<!-- 모달 팝업 -->
<div class="modal" id="menuModal" style="display: none;">
  <div class="modal_popup">
    <div class="header">
      <h3 id="modalTitle">가게 이름</h3>

    </div>
    <div class="button_below_title">
      <a href="reservation.html" class="reserve_page_btn">예약하기</a>
    </div>
    <span id="modalContent">여기에 가게에 대한 상세 설명이 들어갑니다.</span>
    <ul class="menu_list" id="menuList">
      <!-- 메뉴 list -->
    </ul>
    <button type="button" class="close_btn" onclick="closeModal()">닫기</button>
  </div>
</div>


    <!-- end 모달 팝업 -->
    <div class="container">
      <header id="site-header">
        <div id="logo">GFOOD</div>
        <button class="header-button" id="a-button" data-type="a" data-icon="https://ifh.cc/g/yHPtBj.png">결식 카드</button>
        <button class="header-button" id="b-button" data-type="b" data-icon="https://ifh.cc/g/500jMW.png">착한식당</button>
        <button class="header-button" id="c-button" data-type="c" data-icon="https://ifh.cc/g/pxATFR.png">편의점</button>

      </header>
      <section>
        <div id="map"></div>
      </section>
      <footer>
        <ul>
            <li><a href="index.html" id="back"><span class="material-symbols-outlined">home</span>홈</a></li>
            <li><a href="search.html" id="search"><span class="material-symbols-outlined">search</span>검색</a></li>
            <li><a href="reservation.html" id="reservation"><span class="material-symbols-outlined">event</span>예약</a></li>
            <li><a href="profile.html" id="profile"><span class="material-symbols-outlined">person</span>회원정보</a></li>
        </ul>
    </footer>
      </footer>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
    const modal = document.querySelector(".modal");
    const modalClose = document.querySelector(".close_btn");
    const mapElement = document.getElementById("map");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");

    // 모달 닫기 버튼 클릭 시 모달 숨기기 및 지도 블러 제거
    modalClose.addEventListener("click", function () {
        modal.style.display = "none";
        mapElement.classList.remove("blur");
    });

    // 모달 외부 클릭 시 모달 숨기기
    window.addEventListener("click", function (event) {
        if (event.target === modal) {
            modal.style.display = "none";
            mapElement.classList.remove("blur");
        }
    });

    const mapOption = {
        center: new kakao.maps.LatLng(37.5206, 126.9945),
        level: 4
    };

    const map = new kakao.maps.Map(mapElement, mapOption);
    let markers = []; // 마커 배열
    let clusterer = new kakao.maps.MarkerClusterer({
      map: map,
      averageCenter: true,
      minLevel: 6
    })
    let currentOverlay = null; // 현재 오버레이 저장 변수
    let currentType = null; // 현재 선택된 타입 저장 변수

    // 선택된 타입에 따른 좌표 데이터 가져오기
    async function getCoordinatesByType(type) {
        try {
            var bounds = map.getBounds();
            var sw = bounds.getSouthWest(); // 남서쪽 좌표
            var ne = bounds.getNorthEast(); // 북동쪽 좌표
            const response = await fetch(`http://localhost:8002/stores?neLng=${ne.La}&neLat=${ne.Ma}&swLng=${sw.La}&swLat=${sw.Ma}&business_type=${type}`);

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const coordinates = await response.json();
            return coordinates; // 좌표 반환
        } catch (error) {
            console.error("Error fetching coordinates data:", error);
            alert("상점 데이터를 불러오는 데 실패했습니다. 나중에 다시 시도해 주세요.");
            return []; // 빈 배열 반환
        }
    }

    // 버튼 클릭 시 마커 추가
    document.querySelectorAll(".header-button").forEach(button => {
        button.addEventListener("click", async function () {
            const type = this.getAttribute("data-type");
            const markerIcon = this.getAttribute("data-icon");
            await markertype(type, markerIcon); // 마커 타입에 따라 마커 추가
        });
    });

    // 마커 추가 함수
    function addMarker(store, markerIcon) {
        const pos = new kakao.maps.LatLng(store.x_coordinate, store.y_coordinate);
        const imageSize = new kakao.maps.Size(94, 99);
        const imageOption = { offset: new kakao.maps.Point(44, 79) };
        const markerImage = new kakao.maps.MarkerImage(markerIcon, imageSize, imageOption);
        const marker = new kakao.maps.Marker({
            map: map,
            position: pos,
            image: markerImage
        });

        kakao.maps.event.addListener(marker, "click", function () {
            if (currentOverlay) {
                currentOverlay.setMap(null); // 이전 오버레이 제거
            }

            const overlayContent = document.createElement("div");
            overlayContent.innerHTML = `<div class="overlay-content">
                <h3>${store.name}</h3>
                <span>${store.type}</span>
            </div>`;
            
            overlayContent.querySelector(".overlay-content").onclick = function () {
                getDetail(store); // 상세 정보 보기
                modal.style.display = "block"; // 모달 표시
                mapElement.classList.add("blur"); // 지도 블러 처리
            };
            const overlay = new kakao.maps.CustomOverlay({
                position: pos,
                content: overlayContent,
            });

            currentOverlay = overlay; // 현재 오버레이 업데이트
            overlay.setMap(map); // 오버레이 지도에 표시
        });
        markers.push({ store, marker }); // 마커 배열에 저장
    }

    // 모든 마커 제거 함수
    function clearMarkers() {
        markers.forEach(({ marker }) => marker.setMap(null)); // 지도에서 마커 제거
        markers = []; // 마커 배열 초기화
        clusterer.clear()
    }

    // 마커 타입에 따라 좌표 데이터 가져오기
    async function markertype(type, markerIcon) {
        try {
            const coordinates = await getCoordinatesByType(type);
            clearMarkers(); // 이전 마커 제거
            coordinates.forEach(coord => {
                const store = {
                    x_coordinate: coord.x_coordinate,
                    y_coordinate: coord.y_coordinate,
                    name: coord.name,
                    type: coord.business_type,
                    id: coord.idx // 추가된 id 필드
                };
                addMarker(store, markerIcon); // 마커 추가
            });
            const res = []
            markers.forEach((marker, i)=>{
              res.push(marker.marker)
            })
            clusterer.addMarkers(res)
        } catch (error) {
            console.error("Error fetching store data:", error);
        }
    }

    // 상세 정보 가져오기
    async function getDetail(store) {
        try {
            const response = await fetch(`http://localhost:8002/stores/${store.id}/menu`);

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const menuItems = await response.json();

            // 첫 번째 메뉴 항목에서 store_name을 가져와 제목 설정
            if (menuItems.length > 0) {
                const firstItem = menuItems[0];
                modalTitle.textContent = firstItem.store_name;
                const menuList = menuItems.map(item => `<li>${item.menu_name}</li>`).join("");

                modalContent.innerHTML = `
                  <ul>${menuList}</ul>
                `; // 모달 내용 설정
            } else {
                modalTitle.textContent = "정보 없음";
                modalContent.innerHTML = "해당 가게의 메뉴 정보가 없습니다.";
            }

            modal.style.display = "block"; // 모달 표시
            mapElement.classList.add("blur"); // 지도 블러 처리
        } catch (error) {
            console.error("Error fetching store detail:", error);
            modalTitle.textContent = `${store.name}`;
            modalContent.innerHTML = "메뉴가 제공되지 않습니다.";
        }
    }
});


      window.onload = function(){
        const urlParams = new URLSearchParams(window.location.search)
        window.name =urlParams.get("user_id")
      }
    </script>
    
</body>
</html>